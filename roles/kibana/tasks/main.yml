---
# tasks file for kibana
- name: install kibana
  apt:
    name: 
    - kibana

- name: rest
  shell:
    cmd: /usr/share/elasticsearch/bin/elasticsearch-reset-password -u kibana_system -b
  register: reset_cmd
    # changed_when: false

- name: preference kibana
  lineinfile:
    dest: /etc/kibana/kibana.yml
    regexp: "{{ item.regexp }}"
    line: "{{ item.line }}"
  with_items:
    - { regexp: '^#server.host: "localhost"', line: 'server.host: "192.168.56.15"'}
    - { regexp: '^#elasticsearch.ssl.certificateAuthorities', line: "elasticsearch.ssl.certificateAuthorities: [ '/etc/kibana/certs/http_ca.crt' ]" }
    - { regexp: '^#elasticsearch.hosts', line: "elasticsearch.hosts: ['https://localhost:9200']" }
    - { regexp: "^#elasticsearch.password", line: "elasticsearch.password: '{{ my_password }}' " }
    - { regexp: "^#elasticsearch.username", line: "elasticsearch.username: 'kibana_system'" }
      # when: reset_cmd.stdout == "Absent"

- name: create dir
  file:
    path: "{{ kib_certs }}"
    state: directory

- name: copy sign serts elastic
  copy:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    remote_src: yes
  with_items:
    - { src: "{{ http_ca }}", dest: "{{ kib_certs }}" }
    - { src: "{{ http }}", dest: "{{ kib_certs }}" }
    - { src: "{{ transport }}", dest: "{{ kib_certs }}" }

- name: change mode
  file:
    path: "{{ kib_certs }}"
    state: directory
    recurse: yes
    owner: root
    group: kibana

- name: service enable
  service:
    name: kibana 
    state: started
    enabled: yes

